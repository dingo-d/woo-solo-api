name: Deploy to WordPress.org

on:
    push:
        tags:
            - "*"

jobs:
    tag:
        name: New version tag
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v2

            - name: Get Composer Cache Directory
                  id: composer-cache
                  run: |
                    echo "::set-output name=dir::$(composer config cache-files-dir)"

            - name: Cache Composer Downloads
              uses: actions/cache@v2
              with:
                path: vendor/
                key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
                restore-keys: |
                  ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

            - name: Cache PHP dependencies
              uses: actions/cache@v2
              with:
                path: vendor
                key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

            - uses: php-actions/composer@v4
              with:
                dev: no
                php_version: 7.3
                composer_version: 1

            -   name: Build plugin
                run: |
                    npm install
                    npm run build

            -   name: Deploy plugin to wordpress.org
                uses: 10up/action-wordpress-plugin-deploy@stable
                env:
                    SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
                    SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
